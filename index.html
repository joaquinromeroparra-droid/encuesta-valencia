<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuesta Ciudadana Valencia</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; border-radius: 16px; padding: 32px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #ea580c; font-size: 32px; margin-bottom: 8px; text-align: center; }
        .subtitle { color: #6b7280; text-align: center; margin-bottom: 24px; }
        .warning { background: #fef3c7; border: 2px solid #fbbf24; padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 24px; color: #92400e; font-weight: 600; }
        .info { background: #dbeafe; border: 2px solid #3b82f6; padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 24px; color: #1e40af; font-weight: 600; }
        label { display: block; color: #374151; font-weight: 600; margin-bottom: 8px; }
        select, input { width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 16px; margin-bottom: 16px; }
        select:focus, input:focus { outline: none; border-color: #ea580c; }
        .question { background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 16px; }
        .range-container { display: flex; align-items: center; gap: 8px; margin-top: 12px; }
        .range-label { min-width: 32px; color: #6b7280; font-size: 14px; }
        input[type="range"] { flex: 1; height: 8px; border-radius: 4px; background: #d1d5db; }
        .value-display { min-width: 48px; text-align: center; font-size: 24px; font-weight: bold; color: #ea580c; }
        .consent-box { background: #dbeafe; border: 2px solid #3b82f6; padding: 16px; border-radius: 8px; margin-bottom: 24px; }
        .consent-box label { display: flex; align-items: start; gap: 12px; font-weight: normal; }
        input[type="checkbox"] { width: 20px; height: 20px; margin-top: 4px; cursor: pointer; }
        .button-group { display: flex; gap: 16px; }
        button { flex: 1; padding: 16px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #ea580c; color: white; }
        .btn-primary:hover { background: #c2410c; }
        .btn-primary:disabled { background: #d1d5db; cursor: not-allowed; }
        .btn-secondary { background: transparent; border: 2px solid #d1d5db; }
        .btn-secondary:hover { background: #f3f4f6; }
        .admin-btn { width: 64px; padding: 16px; }
        .success-card { text-align: center; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); }
        .success-icon { font-size: 80px; margin-bottom: 16px; }
        .admin-card { background: #f9fafb; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .stat-value { font-size: 32px; font-weight: bold; color: #ea580c; }
        .stat-label { color: #6b7280; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background: #f9fafb; font-weight: 600; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 14px; font-weight: 600; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-yellow { background: #fef3c7; color: #92400e; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; padding: 20px; z-index: 1000; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 24px; border-radius: 12px; max-width: 400px; width: 100%; }
        .error { color: #dc2626; font-size: 14px; margin-top: 4px; }
        .device-id { text-align: center; color: #6b7280; font-size: 14px; margin-top: 8px; }
        .loading { text-align: center; padding: 40px; color: #6b7280; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // CONFIGURACI√ìN SUPABASE
        const SUPABASE_URL = 'https://gnaczccnprnuqbjmzdts.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduYWN6Y2NucHJudXFiam16ZHRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzNzQ2MTIsImV4cCI6MjA4MTk1MDYxMn0.A4__oNG_N_M5x61wI12fk-iTXZgsMDDRvYQRT0cmSmg';
        
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // DATOS
        const BARRIOS = ['Ciutat Vella', 'Eixample', 'Extramurs', 'Campanar', 'La Sa√Ødia', 'El Pla del Real', "L'Olivereta", 'Patraix', 'Jes√∫s', 'Quatre Carreres', 'Poblats Mar√≠tims', 'Camins al Grau', 'Algir√≥s', 'Benimaclet', 'Rascanya', 'Benicalap', 'Pobles del Nord', "Pobles de l'Oest", 'Pobles del Sud'];
        
        const PREGUNTAS = [
            { id: 'seguridad', text: 'Seguridad ciudadana (delincuencia, iluminaci√≥n nocturna)' },
            { id: 'limpieza', text: 'Limpieza y residuos (basuras, limpieza de calles)' },
            { id: 'transporte', text: 'Transporte p√∫blico (frecuencia, conexiones)' },
            { id: 'zonas_verdes', text: 'Zonas verdes y jardines (mantenimiento, cantidad)' },
            { id: 'ruido', text: 'Ruido y contaminaci√≥n' },
            { id: 'calles', text: 'Estado de calles y aceras' },
            { id: 'sanidad', text: 'Servicios sanitarios' },
            { id: 'comercio', text: 'Comercio local' },
            { id: 'vivienda', text: 'Vivienda (acceso, precios)' }
        ];

        // ESTADO
        let state = {
            view: 'encuesta',
            encuestas: [],
            modoPractica: true,
            dispositivoId: localStorage.getItem('dispositivo_valencia_id') || '',
            formData: { barrio: '', consentimiento: false, respuestas: {} },
            errors: {},
            showAdminLogin: false,
            loading: false,
            enviando: false
        };

        // Inicializar respuestas en 5
        PREGUNTAS.forEach(p => { state.formData.respuestas[p.id] = 5; });

        // Generar ID de dispositivo
        if (!state.dispositivoId) {
            state.dispositivoId = 'device_' + Math.random().toString(36).substr(2, 9) + Date.now();
            localStorage.setItem('dispositivo_valencia_id', state.dispositivoId);
        }

        // FUNCIONES SUPABASE
        async function cargarEncuestas() {
            try {
                const { data, error } = await supabaseClient
                    .from('encuestas')
                    .select('*')
                    .order('fecha', { ascending: false });
                
                if (error) {
                    console.error('Error detallado cargando encuestas:', error);
                    console.error('Mensaje:', error.message);
                    console.error('Detalles:', error.details);
                    throw error;
                }
                state.encuestas = data || [];
                console.log('‚úÖ Encuestas cargadas:', state.encuestas.length);
            } catch (error) {
                console.error('Error cargando encuestas:', error.message || error);
                state.encuestas = [];
            }
        }

        async function cargarModoPractica() {
            try {
                const { data, error } = await supabaseClient
                    .from('configuracion')
                    .select('valor')
                    .eq('clave', 'modo_practica')
                    .single();
                
                if (error) {
                    console.error('Error detallado modo pr√°ctica:', error);
                    console.error('Mensaje:', error.message);
                    console.error('Detalles:', error.details);
                    throw error;
                }
                state.modoPractica = data.valor === 'true';
                console.log('‚úÖ Modo pr√°ctica cargado:', state.modoPractica);
            } catch (error) {
                console.error('Error cargando modo pr√°ctica:', error.message || error);
                state.modoPractica = true;
            }
        }

        async function guardarModoPractica(valor) {
            try {
                const { error } = await supabaseClient
                    .from('configuracion')
                    .update({ valor: valor.toString(), updated_at: new Date().toISOString() })
                    .eq('clave', 'modo_practica');
                
                if (error) throw error;
            } catch (error) {
                console.error('Error guardando modo pr√°ctica:', error);
            }
        }

        async function inicializar() {
            state.loading = true;
            render();
            await cargarEncuestas();
            await cargarModoPractica();
            state.loading = false;
            render();
        }

        function puedeEnviar() {
            if (state.modoPractica) return true;
            const ultima = state.encuestas
                .filter(e => e.dispositivo_id === state.dispositivoId)
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))[0];
            if (!ultima) return true;
            return (Date.now() - new Date(ultima.fecha).getTime()) > 90 * 24 * 60 * 60 * 1000;
        }

        function validar() {
            state.errors = {};
            if (!state.formData.barrio) state.errors.barrio = 'Selecciona un barrio';
            if (!state.formData.consentimiento) state.errors.consentimiento = 'Debes aceptar';
            return Object.keys(state.errors).length === 0;
        }

        async function enviar() {
            if (!puedeEnviar()) return alert('Debes esperar 3 meses');
            if (!validar()) return alert('Completa todos los campos');
            
            state.enviando = true;
            render();

            try {
                const { data, error } = await supabaseClient
                    .from('encuestas')
                    .insert([{
                        barrio: state.formData.barrio,
                        dispositivo_id: state.dispositivoId,
                        consentimiento: true,
                        seguridad: state.formData.respuestas.seguridad,
                        limpieza: state.formData.respuestas.limpieza,
                        transporte: state.formData.respuestas.transporte,
                        zonas_verdes: state.formData.respuestas.zonas_verdes,
                        ruido: state.formData.respuestas.ruido,
                        calles: state.formData.respuestas.calles,
                        sanidad: state.formData.respuestas.sanidad,
                        comercio: state.formData.respuestas.comercio,
                        vivienda: state.formData.respuestas.vivienda
                    }])
                    .select();
                
                if (error) throw error;

                state.view = 'exito';
                state.formData = { barrio: '', consentimiento: false, respuestas: {} };
                PREGUNTAS.forEach(p => { state.formData.respuestas[p.id] = 5; });
                await cargarEncuestas();
            } catch (error) {
                console.error('Error enviando encuesta:', error);
                alert('Error al enviar la encuesta. Por favor, intenta de nuevo.');
            }

            state.enviando = false;
            render();
        }

        function exportarCSV() {
            if (state.encuestas.length === 0) return alert('No hay datos');
            
            const headers = ['Fecha', 'Hora', 'Barrio', 'Dispositivo', 'Seguridad', 'Limpieza', 'Transporte', 'Zonas Verdes', 'Ruido', 'Calles', 'Sanidad', 'Comercio', 'Vivienda'];
            const rows = state.encuestas.map(e => {
                const f = new Date(e.fecha);
                return [
                    f.toLocaleDateString('es-ES'),
                    f.toLocaleTimeString('es-ES'),
                    e.barrio,
                    e.dispositivo_id,
                    e.seguridad || 0,
                    e.limpieza || 0,
                    e.transporte || 0,
                    e.zonas_verdes || 0,
                    e.ruido || 0,
                    e.calles || 0,
                    e.sanidad || 0,
                    e.comercio || 0,
                    e.vivienda || 0
                ];
            });
            
            const csv = '\uFEFF' + [headers, ...rows].map(r => r.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'encuestas_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('‚úì ' + state.encuestas.length + ' encuestas exportadas');
        }

        function calcularStats() {
            const stats = {};
            state.encuestas.forEach(e => {
                if (!stats[e.barrio]) {
                    stats[e.barrio] = { barrio: e.barrio, count: 0, promedios: {} };
                    PREGUNTAS.forEach(p => { stats[e.barrio].promedios[p.id] = []; });
                }
                stats[e.barrio].count++;
                PREGUNTAS.forEach(p => { stats[e.barrio].promedios[p.id].push(e[p.id] || 0); });
            });
            
            Object.keys(stats).forEach(b => {
                PREGUNTAS.forEach(p => {
                    const v = stats[b].promedios[p.id];
                    stats[b].promedios[p.id] = v.reduce((a, c) => a + c, 0) / v.length;
                });
            });
            return Object.values(stats);
        }

        // RENDER
        function render() {
            const app = document.getElementById('app');
            
            if (state.loading) {
                app.innerHTML = `
                    <div class="container">
                        <div class="card">
                            <div class="loading">
                                <h2>Cargando...</h2>
                                <p>Conectando con la base de datos</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            if (state.view === 'encuesta') {
                app.innerHTML = `
                    <div class="container">
                        <div class="card">
                            <h1>Encuesta Ciudadana Valencia</h1>
                            <p class="subtitle">Tu opini√≥n es importante para mejorar nuestros barrios</p>
                            
                            <div class="info">‚òÅÔ∏è Conectado a base de datos en la nube - ${state.encuestas.length} encuestas registradas</div>
                            
                            ${state.modoPractica ? '<div class="warning">‚ö†Ô∏è MODO PR√ÅCTICA ACTIVADO</div>' : ''}
                            
                            <label>Selecciona tu barrio *</label>
                            <select id="barrio" onchange="updateBarrio(this.value)" ${state.enviando ? 'disabled' : ''}>
                                <option value="">-- Selecciona un barrio --</option>
                                ${BARRIOS.map(b => `<option value="${b}" ${state.formData.barrio === b ? 'selected' : ''}>${b}</option>`).join('')}
                            </select>
                            ${state.errors.barrio ? `<div class="error">${state.errors.barrio}</div>` : ''}
                            
                            <h2 style="margin: 24px 0 8px 0; font-size: 20px;">Valora la problem√°tica (0-10)</h2>
                            <p style="color: #6b7280; font-size: 14px; margin-bottom: 16px;">0 = Sin problemas | 10 = Problema muy grave</p>
                            
                            ${PREGUNTAS.map(p => `
                                <div class="question">
                                    <label>${p.text}</label>
                                    <div class="range-container">
                                        <span class="range-label">0</span>
                                        <input type="range" min="0" max="10" value="${state.formData.respuestas[p.id]}" 
                                            oninput="updateRespuesta('${p.id}', this.value)" ${state.enviando ? 'disabled' : ''}>
                                        <span class="range-label">10</span>
                                        <span class="value-display" id="val-${p.id}">${state.formData.respuestas[p.id]}</span>
                                    </div>
                                </div>
                            `).join('')}
                            
                            <div class="consent-box">
                                <label>
                                    <input type="checkbox" ${state.formData.consentimiento ? 'checked' : ''} 
                                        onchange="updateConsentimiento(this.checked)" ${state.enviando ? 'disabled' : ''}>
                                    <span><strong>Protecci√≥n de datos:</strong> Acepto que mis datos sean procesados de forma an√≥nima con fines estad√≠sticos. Los datos recogidos cumplen con el RGPD.</span>
                                </label>
                                ${state.errors.consentimiento ? `<div class="error">${state.errors.consentimiento}</div>` : ''}
                            </div>
                            
                            <div class="button-group">
                                <button class="btn-primary" onclick="enviar()" ${state.enviando ? 'disabled' : ''}>
                                    ${state.enviando ? 'Enviando...' : 'Enviar Encuesta'}
                                </button>
                                <button class="btn-secondary admin-btn" onclick="showAdminLogin()" ${state.enviando ? 'disabled' : ''}>‚öôÔ∏è</button>
                            </div>
                        </div>
                        <div class="device-id">ID Dispositivo: ${state.dispositivoId.substring(0, 15)}...</div>
                    </div>
                `;
            } else if (state.view === 'exito') {
                app.innerHTML = `
                    <div class="container">
                        <div class="card success-card">
                            <div class="success-icon">‚úÖ</div>
                            <h1>¬°Encuesta Enviada!</h1>
                            <p class="subtitle">Gracias por tu participaci√≥n. Los datos se han guardado en la nube.</p>
                            <button class="btn-primary" onclick="volver()">Volver al inicio</button>
                        </div>
                    </div>
                `;
            } else if (state.view === 'admin') {
                const stats = calcularStats();
                app.innerHTML = `
                    <div class="container">
                        <div class="card admin-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                <div>
                                    <h1 style="text-align: left; margin-bottom: 4px;">Panel Admin</h1>
                                    <p class="subtitle" style="text-align: left; margin: 0;">Datos desde Supabase (nube)</p>
                                </div>
                                <button class="btn-secondary" onclick="volver()">Salir</button>
                            </div>
                            
                            <div class="stats-grid">
                                <div class="stat-box">
                                    <div class="stat-value">${state.encuestas.length}</div>
                                    <div class="stat-label">Total Encuestas (nube)</div>
                                </div>
                                <div class="stat-box">
                                    <button onclick="togglePractica()" class="btn-primary" style="width: 100%;">
                                        Modo: ${state.modoPractica ? 'PR√ÅCTICA' : 'PRODUCCI√ìN'}
                                    </button>
                                </div>
                                <div class="stat-box">
                                    <button onclick="exportarCSV()" class="btn-primary" style="width: 100%; background: #10b981;">
                                        üì• Exportar CSV
                                    </button>
                                </div>
                            </div>
                            
                            ${state.encuestas.length > 0 ? `
                                <h2 style="margin-top: 24px; margin-bottom: 16px;">Resumen por Barrios</h2>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Barrio</th>
                                            <th>N¬∞</th>
                                            <th>Seguridad</th>
                                            <th>Limpieza</th>
                                            <th>Promedio</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${stats.map(s => {
                                            const prom = Object.values(s.promedios).reduce((a, b) => a + b, 0) / 9;
                                            return `
                                                <tr>
                                                    <td><strong>${s.barrio}</strong></td>
                                                    <td>${s.count}</td>
                                                    <td><span class="badge ${s.promedios.seguridad > 7 ? 'badge-red' : s.promedios.seguridad > 4 ? 'badge-yellow' : 'badge-green'}">${s.promedios.seguridad.toFixed(1)}</span></td>
                                                    <td><span class="badge ${s.promedios.limpieza > 7 ? 'badge-red' : s.promedios.limpieza > 4 ? 'badge-yellow' : 'badge-green'}">${s.promedios.limpieza.toFixed(1)}</span></td>
                                                    <td><span class="badge ${prom > 7 ? 'badge-red' : prom > 4 ? 'badge-yellow' : 'badge-green'}"><strong>${prom.toFixed(1)}</strong></span></td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            ` : '<p style="text-align: center; color: #6b7280; padding: 40px;">No hay encuestas todav√≠a</p>'}
                        </div>
                    </div>
                `;
            }
            
            // Modal admin
            if (state.showAdminLogin) {
                app.innerHTML += `
                    <div class="modal show">
                        <div class="modal-content">
                            <h2 style="margin-bottom: 16px;">Acceso Administrador</h2>
                            <input type="password" id="adminPass" placeholder="Contrase√±a" 
                                onkeypress="if(event.key==='Enter')checkAdmin()" style="margin-bottom: 16px;">
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-primary" onclick="checkAdmin()">Entrar</button>
                                <button class="btn-secondary" onclick="closeAdminLogin()">Cancelar</button>
                            </div>
                            <p style="text-align: center; color: #6b7280; font-size: 12px; margin-top: 12px;">Contrase√±a: admin2025</p>
                        </div>
                    </div>
                `;
            }
        }

        // EVENTOS
        function updateBarrio(value) {
            state.formData.barrio = value;
            delete state.errors.barrio;
            render();
        }

        function updateRespuesta(id, value) {
            state.formData.respuestas[id] = parseInt(value);
            document.getElementById('val-' + id).textContent = value;
        }

        function updateConsentimiento(checked) {
            state.formData.consentimiento = checked;
            delete state.errors.consentimiento;
            render();
        }

        function showAdminLogin() {
            state.showAdminLogin = true;
            render();
        }

        function closeAdminLogin() {
            state.showAdminLogin = false;
            render();
        }

        async function checkAdmin() {
            const pass = document.getElementById('adminPass')?.value || '';
            if (pass === 'xim@0408') {
                state.view = 'admin';
                state.showAdminLogin = false;
                await cargarEncuestas();
                render();
            } else {
                alert('Contrase√±a incorrecta');
            }
        }

        function volver() {
            state.view = 'encuesta';
            render();
        }

        async function togglePractica() {
            state.modoPractica = !state.modoPractica;
            await guardarModoPractica(state.modoPractica);
            render();
        }

        // Iniciar
        inicializar();
        console.log('‚úÖ Aplicaci√≥n conectada a Supabase');
    </script>
</body>
</html>

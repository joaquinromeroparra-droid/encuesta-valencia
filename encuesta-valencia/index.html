<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuesta Ciudadana Valencia</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/3.4.1/tailwind.min.css" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.5.0/dist/Recharts.js"></script>
    <style>
        /* Estilos personalizados para compensar la falta de configuraci√≥n de Tailwind */
        input[type="range"] {
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #ea580c;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #ea580c;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        input[type="checkbox"]:checked {
            background-color: #ea580c;
            border-color: #ea580c;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar } = Recharts;

        const BARRIOS_VALENCIA = [
          'Ciutat Vella', 'Eixample', 'Extramurs', 'Campanar', 'La Sa√Ødia',
          'El Pla del Real', "L'Olivereta", 'Patraix', 'Jes√∫s', 'Quatre Carreres',
          'Poblats Mar√≠tims', 'Camins al Grau', 'Algir√≥s', 'Benimaclet', 'Rascanya',
          'Benicalap', 'Pobles del Nord', "Pobles de l'Oest", 'Pobles del Sud'
        ];

        const PREGUNTAS = [
          { id: 'seguridad', text: 'Seguridad ciudadana (delincuencia, iluminaci√≥n nocturna)' },
          { id: 'limpieza', text: 'Limpieza y residuos (basuras, limpieza de calles)' },
          { id: 'transporte', text: 'Transporte p√∫blico (frecuencia, conexiones)' },
          { id: 'zonas_verdes', text: 'Zonas verdes y jardines (mantenimiento, cantidad)' },
          { id: 'ruido', text: 'Ruido y contaminaci√≥n' },
          { id: 'calles', text: 'Estado de calles y aceras' },
          { id: 'sanidad', text: 'Servicios sanitarios' },
          { id: 'comercio', text: 'Comercio local' },
          { id: 'vivienda', text: 'Vivienda (acceso, precios)' }
        ];

        // Simulaci√≥n de window.storage para GitHub Pages
        const storage = {
          get: (key) => {
            try {
              const val = localStorage.getItem(key);
              return val ? { value: val } : null;
            } catch {
              return null;
            }
          },
          set: (key, value) => {
            try {
              localStorage.setItem(key, value);
              return { key, value };
            } catch {
              return null;
            }
          }
        };

        const App = () => {
          const [view, setView] = useState('encuesta');
          const [modoPractica, setModoPractica] = useState(true);
          const [encuestas, setEncuestas] = useState([]);
          const [dispositivoId, setDispositivoId] = useState('');
          const [adminPassword, setAdminPassword] = useState('');
          const [showAdminLogin, setShowAdminLogin] = useState(false);
          const [barrioSeleccionado, setBarrioSeleccionado] = useState('');
          const [formData, setFormData] = useState({
            barrio: '',
            consentimiento: false,
            respuestas: PREGUNTAS.reduce((acc, p) => ({ ...acc, [p.id]: 5 }), {})
          });
          const [errors, setErrors] = useState({});

          useEffect(() => {
            cargarDatos();
            generarDispositivoId();
          }, []);

          const cargarDatos = () => {
            try {
              const stored = storage.get('encuestas_valencia');
              if (stored?.value) setEncuestas(JSON.parse(stored.value));
              
              const practica = storage.get('modo_practica');
              if (practica?.value) setModoPractica(JSON.parse(practica.value));
            } catch (error) {
              console.log('Primera vez');
            }
          };

          const guardarDatos = (nuevasEncuestas) => {
            try {
              storage.set('encuestas_valencia', JSON.stringify(nuevasEncuestas));
            } catch (error) {
              console.error('Error:', error);
            }
          };

          const generarDispositivoId = () => {
            let id = localStorage.getItem('dispositivo_valencia_id');
            if (!id) {
              id = 'device_' + Math.random().toString(36).substr(2, 9) + Date.now();
              localStorage.setItem('dispositivo_valencia_id', id);
            }
            setDispositivoId(id);
          };

          const puedeEnviarEncuesta = () => {
            if (modoPractica) return true;
            const ultima = encuestas.filter(e => e.dispositivo_id === dispositivoId)
              .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))[0];
            if (!ultima) return true;
            return (Date.now() - new Date(ultima.fecha).getTime()) > 90 * 24 * 60 * 60 * 1000;
          };

          const handleInputChange = (preguntaId, valor) => {
            setFormData(prev => ({
              ...prev,
              respuestas: { ...prev.respuestas, [preguntaId]: parseInt(valor) }
            }));
            if (errors[preguntaId]) setErrors(prev => ({ ...prev, [preguntaId]: null }));
          };

          const validarFormulario = () => {
            const newErrors = {};
            if (!formData.barrio) newErrors.barrio = 'Debe seleccionar un barrio';
            if (!formData.consentimiento) newErrors.consentimiento = 'Debe aceptar el tratamiento de datos';
            PREGUNTAS.forEach(p => {
              if (formData.respuestas[p.id] === undefined) newErrors[p.id] = 'Requerida';
            });
            setErrors(newErrors);
            return Object.keys(newErrors).length === 0;
          };

          const enviarEncuesta = () => {
            if (!puedeEnviarEncuesta()) {
              alert('Debes esperar 3 meses.');
              return;
            }
            if (!validarFormulario()) {
              alert('Completa todos los campos');
              return;
            }
            
            const nueva = {
              id: Date.now().toString(),
              fecha: new Date().toISOString(),
              barrio: formData.barrio,
              dispositivo_id: dispositivoId,
              consentimiento: true,
              seguridad: formData.respuestas.seguridad,
              limpieza: formData.respuestas.limpieza,
              transporte: formData.respuestas.transporte,
              zonas_verdes: formData.respuestas.zonas_verdes,
              ruido: formData.respuestas.ruido,
              calles: formData.respuestas.calles,
              sanidad: formData.respuestas.sanidad,
              comercio: formData.respuestas.comercio,
              vivienda: formData.respuestas.vivienda
            };
            
            const nuevas = [...encuestas, nueva];
            setEncuestas(nuevas);
            guardarDatos(nuevas);
            setView('exito');
            setFormData({ 
              barrio: '', 
              consentimiento: false, 
              respuestas: PREGUNTAS.reduce((acc, p) => ({ ...acc, [p.id]: 5 }), {})
            });
          };

          const exportarCSV = () => {
            if (encuestas.length === 0) {
              alert('No hay datos');
              return;
            }
            
            const headers = ['Fecha', 'Hora', 'Barrio', 'Dispositivo', 'Seguridad', 'Limpieza', 'Transporte', 'Zonas Verdes', 'Ruido', 'Calles', 'Sanidad', 'Comercio', 'Vivienda'];
            const rows = encuestas.map(e => {
              const fechaObj = new Date(e.fecha);
              const soloFecha = fechaObj.toLocaleDateString('es-ES');
              const soloHora = fechaObj.toLocaleTimeString('es-ES');
              
              return [
                soloFecha,
                soloHora,
                e.barrio,
                e.dispositivo_id,
                e.seguridad ?? 0,
                e.limpieza ?? 0,
                e.transporte ?? 0,
                e.zonas_verdes ?? 0,
                e.ruido ?? 0,
                e.calles ?? 0,
                e.sanidad ?? 0,
                e.comercio ?? 0,
                e.vivienda ?? 0
              ];
            });
            
            const csv = '\uFEFF' + [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `encuestas_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert(`‚úì Exportadas ${encuestas.length} encuestas`);
          };

          const calcularEstadisticas = () => {
            const stats = {};
            encuestas.forEach(e => {
              if (!stats[e.barrio]) {
                stats[e.barrio] = { barrio: e.barrio, count: 0, promedios: {} };
                PREGUNTAS.forEach(p => { stats[e.barrio].promedios[p.id] = []; });
              }
              stats[e.barrio].count++;
              PREGUNTAS.forEach(p => { stats[e.barrio].promedios[p.id].push(e[p.id] || 0); });
            });
            
            Object.keys(stats).forEach(b => {
              PREGUNTAS.forEach(p => {
                const v = stats[b].promedios[p.id];
                stats[b].promedios[p.id] = v.reduce((a, c) => a + c, 0) / v.length;
              });
            });
            return Object.values(stats);
          };

          const promediosGenerales = () => {
            return PREGUNTAS.map(p => {
              const v = encuestas.map(e => e[p.id] || 0);
              const prom = v.reduce((a, b) => a + b, 0) / v.length || 0;
              return { tema: p.text.split('(')[0].trim(), valor: prom };
            });
          };

          const toggleModoPractica = () => {
            const nuevo = !modoPractica;
            setModoPractica(nuevo);
            try {
              storage.set('modo_practica', JSON.stringify(nuevo));
            } catch (error) {
              console.error('Error:', error);
            }
          };

          if (view === 'encuesta') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-orange-50 to-orange-100 p-4">
                <div className="max-w-3xl mx-auto">
                  <div className="bg-white rounded-2xl shadow-xl p-8 mb-4">
                    <div className="text-center mb-8">
                      <h1 className="text-4xl font-bold text-orange-600 mb-2">Encuesta Ciudadana Valencia</h1>
                      <p className="text-gray-600">Tu opini√≥n es importante para mejorar nuestros barrios</p>
                    </div>

                    {modoPractica && (
                      <div className="bg-yellow-100 border border-yellow-300 rounded-lg p-3 mb-6 text-center">
                        <span className="text-yellow-800 font-semibold">‚ö†Ô∏è MODO PR√ÅCTICA ACTIVADO</span>
                      </div>
                    )}

                    <div className="mb-6">
                      <label className="block text-gray-700 font-semibold mb-2">Selecciona tu barrio *</label>
                      <select
                        value={formData.barrio}
                        onChange={(e) => {
                          setFormData(prev => ({ ...prev, barrio: e.target.value }));
                          if (errors.barrio) setErrors(prev => ({ ...prev, barrio: null }));
                        }}
                        className={`w-full p-3 border-2 rounded-lg ${errors.barrio ? 'border-red-500' : 'border-gray-300'}`}
                      >
                        <option value="">-- Selecciona un barrio --</option>
                        {BARRIOS_VALENCIA.map(b => <option key={b} value={b}>{b}</option>)}
                      </select>
                      {errors.barrio && <p className="text-red-500 text-sm mt-1">{errors.barrio}</p>}
                    </div>

                    <div className="space-y-6 mb-8">
                      <h2 className="text-2xl font-bold text-gray-800">Valora la problem√°tica (0-10)</h2>
                      <p className="text-sm text-gray-600">0 = Sin problemas | 10 = Problema muy grave</p>
                      
                      {PREGUNTAS.map(pregunta => (
                        <div key={pregunta.id} className="bg-gray-50 p-4 rounded-lg">
                          <label className="block text-gray-700 font-medium mb-3">{pregunta.text}</label>
                          <div className="flex items-center gap-2">
                            <span className="text-sm text-gray-500 w-8">0</span>
                            <input
                              type="range"
                              min="0"
                              max="10"
                              value={formData.respuestas[pregunta.id] ?? 5}
                              onChange={(e) => handleInputChange(pregunta.id, e.target.value)}
                              className="flex-1 h-2 bg-gray-300 rounded-lg accent-orange-500"
                            />
                            <span className="text-sm text-gray-500 w-8">10</span>
                            <span className="text-2xl font-bold text-orange-600 w-12 text-center">
                              {formData.respuestas[pregunta.id] ?? 5}
                            </span>
                          </div>
                        </div>
                      ))}
                    </div>

                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                      <div className="flex items-start gap-3">
                        <input
                          type="checkbox"
                          id="consentimiento"
                          checked={formData.consentimiento}
                          onChange={(e) => {
                            setFormData(prev => ({ ...prev, consentimiento: e.target.checked }));
                            if (errors.consentimiento) setErrors(prev => ({ ...prev, consentimiento: null }));
                          }}
                          className="mt-1 w-5 h-5 accent-orange-500"
                        />
                        <label htmlFor="consentimiento" className="text-sm text-gray-700">
                          <strong>Protecci√≥n de datos:</strong> Acepto que mis datos sean procesados de forma an√≥nima con fines estad√≠sticos. Los datos recogidos cumplen con el RGPD y la Ley Org√°nica 3/2018 de Protecci√≥n de Datos. *
                        </label>
                      </div>
                      {errors.consentimiento && <p className="text-red-500 text-sm mt-2 ml-8">{errors.consentimiento}</p>}
                    </div>

                    <div className="flex gap-4">
                      <button
                        onClick={enviarEncuesta}
                        className="flex-1 bg-orange-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-orange-700"
                      >
                        Enviar Encuesta
                      </button>
                      <button
                        onClick={() => setShowAdminLogin(true)}
                        className="px-6 py-4 border-2 border-gray-300 rounded-lg hover:bg-gray-50"
                      >
                        ‚öôÔ∏è
                      </button>
                    </div>
                  </div>
                  
                  <div className="text-center text-gray-600 text-sm">
                    ID Dispositivo: {dispositivoId.substring(0, 15)}...
                  </div>
                </div>

                {showAdminLogin && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg p-6 max-w-md w-full">
                      <h3 className="text-xl font-bold mb-4">Acceso Administrador</h3>
                      <input
                        type="password"
                        placeholder="Contrase√±a"
                        value={adminPassword}
                        onChange={(e) => setAdminPassword(e.target.value)}
                        onKeyPress={(e) => {
                          if (e.key === 'Enter') {
                            if (adminPassword === 'admin2025') {
                              setView('admin');
                              setShowAdminLogin(false);
                              setAdminPassword('');
                            } else {
                              alert('Incorrecta');
                            }
                          }
                        }}
                        className="w-full p-3 border-2 border-gray-300 rounded-lg mb-4"
                      />
                      <div className="flex gap-2">
                        <button
                          onClick={() => {
                            if (adminPassword === 'admin2025') {
                              setView('admin');
                              setShowAdminLogin(false);
                              setAdminPassword('');
                            } else {
                              alert('Incorrecta');
                            }
                          }}
                          className="flex-1 bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700"
                        >
                          Entrar
                        </button>
                        <button
                          onClick={() => {
                            setShowAdminLogin(false);
                            setAdminPassword('');
                          }}
                          className="flex-1 bg-gray-200 py-2 rounded-lg hover:bg-gray-300"
                        >
                          Cancelar
                        </button>
                      </div>
                      <p className="text-xs text-gray-500 mt-3 text-center">Contrase√±a: admin2025</p>
                    </div>
                  </div>
                )}
              </div>
            );
          }

          if (view === 'exito') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-green-50 to-green-100 flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md text-center">
                  <div className="text-6xl mb-4">‚úÖ</div>
                  <h2 className="text-3xl font-bold text-gray-800 mb-2">¬°Encuesta Enviada!</h2>
                  <p className="text-gray-600 mb-6">Gracias por tu participaci√≥n.</p>
                  <button
                    onClick={() => setView('encuesta')}
                    className="bg-orange-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-orange-700"
                  >
                    Volver
                  </button>
                </div>
              </div>
            );
          }

          // ADMIN (simplificado para el HTML)
          const stats = calcularEstadisticas();
          const promedios = promediosGenerales();
          
          return (
            <div className="min-h-screen bg-gray-100 p-4">
              <div className="max-w-7xl mx-auto">
                <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                  <div className="flex justify-between items-center">
                    <div>
                      <h1 className="text-3xl font-bold text-gray-800">Panel Admin</h1>
                      <p className="text-gray-600">Estad√≠sticas - Total: {encuestas.length}</p>
                    </div>
                    <button onClick={() => setView('encuesta')} className="bg-gray-600 text-white px-6 py-2 rounded-lg">Salir</button>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                  <div className="bg-white rounded-lg shadow-md p-6">
                    <button onClick={toggleModoPractica} className={`w-full py-3 rounded-lg font-semibold ${modoPractica ? 'bg-yellow-500' : 'bg-green-500'} text-white`}>
                      Modo Pr√°ctica: {modoPractica ? 'ON' : 'OFF'}
                    </button>
                  </div>
                  
                  <div className="bg-white rounded-lg shadow-md p-6">
                    <button onClick={exportarCSV} className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">
                      üì• Exportar CSV
                    </button>
                  </div>
                </div>

                {encuestas.length > 0 ? (
                  <div className="bg-white rounded-lg shadow-md p-6">
                    <h2 className="text-xl font-bold mb-4">Resumen por Barrios</h2>
                    <div className="overflow-x-auto">
                      <table className="w-full">
                        <thead>
                          <tr className="bg-gray-100">
                            <th className="p-3 text-left">Barrio</th>
                            <th className="p-3 text-center">N¬∞</th>
                            <th className="p-3 text-center">Seguridad</th>
                            <th className="p-3 text-center">Limpieza</th>
                            <th className="p-3 text-center">Promedio</th>
                          </tr>
                        </thead>
                        <tbody>
                          {stats.map(s => {
                            const prom = Object.values(s.promedios).reduce((a, b) => a + b, 0) / 9;
                            return (
                              <tr key={s.barrio} className="border-b">
                                <td className="p-3 font-semibold">{s.barrio}</td>
                                <td className="p-3 text-center">{s.count}</td>
                                <td className="p-3 text-center">
                                  <span className={`px-2 py-1 rounded ${s.promedios.seguridad > 7 ? 'bg-red-100 text-red-800' : s.promedios.seguridad > 4 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                                    {s.promedios.seguridad.toFixed(1)}
                                  </span>
                                </td>
                                <td className="p-3 text-center">
                                  <span className={`px-2 py-1 rounded ${s.promedios.limpieza > 7 ? 'bg-red-100 text-red-800' : s.promedios.limpieza > 4 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                                    {s.promedios.limpieza.toFixed(1)}
                                  </span>
                                </td>
                                <td className="p-3 text-center">
                                  <span className={`px-3 py-1 rounded font-bold ${prom > 7 ? 'bg-red-200 text-red-900' : prom > 4 ? 'bg-yellow-200 text-yellow-900' : 'bg-green-200 text-green-900'}`}>
                                    {prom.toFixed(1)}
                                  </span>
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  </div>
                ) : (
                  <div className="bg-white rounded-lg shadow-md p-12 text-center">
                    <div className="text-6xl mb-4">üìä</div>
                    <h3 className="text-xl font-bold text-gray-600 mb-2">No hay encuestas</h3>
                  </div>
                )}
              </div>
            </div>
          );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>